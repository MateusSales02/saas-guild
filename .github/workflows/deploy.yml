name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Deploy via SSH para EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script_stop: true
        script: |
          set -e

          echo "== [CI] Instalando Docker Compose =="
          if [ ! -f /usr/local/bin/docker-compose ]; then
            echo "Baixando Docker Compose..."
            sudo curl -SL "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
          fi
          docker-compose --version

          echo "== [CI] Configurando diretório do projeto =="

          # Se o diretório existe mas não tem .git, remove com sudo
          if [ -d ~/saas-guild ] && [ ! -d ~/saas-guild/.git ]; then
            echo "== [CI] Removendo diretório sem git =="
            sudo rm -rf ~/saas-guild
          fi

          # Clona se não existir
          if [ ! -d ~/saas-guild ]; then
            echo "== [CI] Clonando repositório =="
            git clone https://github.com/${{ github.repository }} ~/saas-guild
          fi

          cd ~/saas-guild

          echo "== [CI] Atualizando código =="
          git fetch --all
          git reset --hard origin/main

          echo "== [CI] Parando containers existentes =="
          sudo docker-compose down -v || true

          echo "== [CI] Limpando dados antigos =="
          sudo rm -rf ~/saas-guild/data/postgres || true

          echo "== [CI] Construindo imagens =="
          sudo docker-compose build

          echo "== [CI] Iniciando banco de dados e redis =="
          sudo docker-compose up -d db redis

          echo "== [CI] Aguardando PostgreSQL inicializar (60s) =="
          sleep 10
          echo "== Logs do PostgreSQL após 10s =="
          sudo docker logs saas_db 2>&1 || true

          echo "== Aguardando mais 50s =="
          sleep 50

          echo "== Status dos containers =="
          sudo docker-compose ps

          echo "== Logs finais do PostgreSQL =="
          sudo docker logs saas_db 2>&1 | tail -50 || true

          echo "== [CI] Iniciando API e Web =="
          sudo docker-compose up -d api web || {
            echo "== ERRO nos containers =="
            sudo docker logs saas_guild_api 2>&1 | tail -30 || true
            exit 1
          }

          echo "== [CI] Aguardando containers ficarem saudáveis =="
          sleep 10
          sudo docker-compose ps

          echo "== [CI] Deploy finalizado com sucesso! =="
