name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Deploy via SSH para EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script_stop: true
        script: |
          set -e
          echo "== [CI] Configurando diretório do projeto =="

          # Se o diretório existe mas não tem .git, remove com sudo
          if [ -d ~/saas-guild ] && [ ! -d ~/saas-guild/.git ]; then
            echo "== [CI] Removendo diretório sem git =="
            sudo rm -rf ~/saas-guild
          fi

          # Clona se não existir
          if [ ! -d ~/saas-guild ]; then
            echo "== [CI] Clonando repositório =="
            git clone https://github.com/${{ github.repository }} ~/saas-guild
          fi

          cd ~/saas-guild

          echo "== [CI] Atualizando código =="
          git fetch --all
          git reset --hard origin/main

          echo "== [CI] Parando containers existentes =="
          sudo docker compose down || true

          echo "== [CI] Construindo e subindo containers =="
          sudo docker compose up -d --build

          echo "== [CI] Verificando status dos containers =="
          sudo docker compose ps

          echo "== [CI] Deploy finalizado com sucesso! =="
