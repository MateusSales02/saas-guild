name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Deploy via SSH para EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script_stop: true
        command_timeout: 20m
        script: |
          set -e

          echo "== [CI] Verificando Docker =="
          docker --version

          echo "== [CI] Configurando diretório do projeto =="

          # Se o diretório existe mas não tem .git, remove
          if [ -d ~/saas-guild ] && [ ! -d ~/saas-guild/.git ]; then
            echo "== [CI] Removendo diretório sem git =="
            sudo rm -rf ~/saas-guild
          fi

          # Clona se não existir
          if [ ! -d ~/saas-guild ]; then
            echo "== [CI] Clonando repositório =="
            git clone https://github.com/${{ github.repository }} ~/saas-guild
          fi

          cd ~/saas-guild

          echo "== [CI] Atualizando código =="
          git fetch --all
          git reset --hard origin/main

          # Remove pasta api-backup se existir (causa problemas de submodule)
          rm -rf apps/api/api-backup || true

          echo "== [CI] Parando containers existentes =="
          sudo docker compose down || true

          echo "== [CI] Limpando imagens antigas =="
          sudo docker system prune -f || true

          echo "== [CI] Construindo e iniciando containers =="
          sudo docker compose up -d --build

          echo "== [CI] Aguardando containers iniciarem (30s) =="
          sleep 30

          echo "== [CI] Status dos containers =="
          sudo docker compose ps

          echo "== [CI] Logs da API =="
          sudo docker logs saas_guild_api 2>&1 | tail -50 || true

          echo "== [CI] Deploy finalizado! =="
